<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito | Mi Tienda</title>
    <meta name="description" content="Tu carrito de compras en Mi Tienda.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">

    <!-- CSS - Sistema Modular -->
    <link rel="stylesheet" href="../css/main.css?v=3.0">
    <link rel="stylesheet" href="../css/components/wishlist.css?v=3.0">
    <link rel="stylesheet" href="../css/pages/carrito.css?v=3.1">
</head>

<body class="cart-page">
    <!-- Skip Link -->
    <a href="#main" class="skip-link">Ir al contenido principal</a>

    <!-- Header Component -->
    <header class="header-container">
        <!-- Info Banner -->
        <div class="header-info">
            <p>Env√≠o gratis en compras sobre $50.000 | Lunes a Viernes 9:00 - 18:00hrs</p>
        </div>

        <!-- Navbar -->
        <nav class="header-nav">
            <div class="container">
                <button class="menu-toggle" aria-label="Men√∫">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12" />
                        <line x1="3" y1="6" x2="21" y2="6" />
                        <line x1="3" y1="18" x2="21" y2="18" />
                    </svg>
                </button>

                <a href="../home.html" class="header-logo">MT</a>

                <ul class="nav-links">
                    <li><a href="../home.html">Inicio</a></li>
                    <li><a href="productos.html">Productos</a></li>
                    <li><a href="nosotros.html">Nosotros</a></li>
                    <li><a href="contacto.html">Contacto</a></li>
                </ul>

                <!-- B√∫squeda Expandible -->
                <div class="header-search">
                    <button class="search-icon" aria-label="Buscar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                    </button>
                    <input type="text" placeholder="Buscar productos...">
                </div>

                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">
                        <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>

                    <a href="wishlist.html" class="wishlist-header-btn" aria-label="Favoritos">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                        </svg>
                        <span class="wishlist-count" style="display:none;">0</span>
                    </a>

                    <a href="carrito.html" class="cart-btn active" aria-label="Carrito">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                        </svg>
                        <span class="cart-count" id="cartCount" style="display:none;">0</span>
                    </a>

                    <button class="user-btn" aria-label="Usuario">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <span>Men√∫</span>
            <button class="mobile-close" aria-label="Cerrar">&times;</button>
        </div>
        <nav class="mobile-nav">
            <a href="../home.html">Inicio</a>
            <a href="productos.html">Productos</a>
            <a href="nosotros.html">Nosotros</a>
            <a href="contacto.html">Contacto</a>
            <a href="login.html">Ingresar</a>
        </nav>
    </div>
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Main Content -->
    <main id="main" class="carrito-container">
        <div class="container">

            <!-- Cart Header -->
            <div class="carrito-page-header">
                <button class="btn-back" onclick="history.back()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Volver
                </button>

                <div class="carrito-title">
                    <h1>
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                        </svg>
                        Mi Carrito
                    </h1>
                    <p id="cartItemCount">0 productos</p>
                </div>

                <button class="btn-clear-cart" id="clearCartBtn" style="display:none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Vaciar
                </button>
            </div>

            <!-- Cart Content -->
            <div class="carrito-grid">
                <div class="carrito-items" id="carritoItems">
                    <!-- Items render here -->
                </div>

                <div class="carrito-summary-wrapper">
                    <div class="carrito-summary">
                        <h3>Resumen del Pedido</h3>

                        <div class="discount-input">
                            <input type="text" class="form-input" id="discountCode" placeholder="C√≥digo de descuento">
                            <button class="btn btn-outline btn-sm" id="applyDiscount">Aplicar</button>
                        </div>

                        <div class="summary-details">
                            <div class="summary-row">
                                <span>Productos (<span id="summaryItemCount">0</span>)</span>
                                <span id="subtotal">$0</span>
                            </div>
                            <div class="summary-row">
                                <span>Env√≠o</span>
                                <span id="shippingCost">Por calcular</span>
                            </div>
                            <div class="summary-row" id="discountRow" style="display: none;">
                                <span>Descuento</span>
                                <span id="discountAmount" class="discount-value">-$0</span>
                            </div>
                            <div class="summary-divider"></div>
                            <div class="summary-row summary-total">
                                <span>Total</span>
                                <span id="total">$0</span>
                            </div>
                        </div>

                        <button class="btn-checkout" id="checkoutBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Proceder al Pago
                        </button>

                        <a href="productos.html" class="btn-continue-shopping">
                            Continuar Comprando ‚Üí
                        </a>
                    </div>

                    <!-- Trust Badges -->
                    <div class="trust-badges">
                        <div class="trust-badge">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            <span>Pago Seguro</span>
                        </div>
                        <div class="trust-badge">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="3" width="15" height="13"></rect>
                                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                <circle cx="18.5" cy="18.5" r="2.5"></circle>
                            </svg>
                            <span>Env√≠o Gratis +$50k</span>
                        </div>
                        <div class="trust-badge">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10"></polyline>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                            </svg>
                            <span>30 D√≠as Devoluci√≥n</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer" id="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section footer-brand">
                    <span class="footer-logo">MT</span>
                    <p>Tu tienda online de confianza.</p>
                </div>

                <div class="footer-section footer-links">
                    <h4 class="footer-title">Enlaces</h4>
                    <ul>
                        <li><a href="../home.html">Inicio</a></li>
                        <li><a href="productos.html">Productos</a></li>
                        <li><a href="nosotros.html">Nosotros</a></li>
                        <li><a href="contacto.html">Contacto</a></li>
                    </ul>
                </div>

                <div class="footer-section footer-contact">
                    <h4 class="footer-title">Contacto</h4>
                    <ul>
                        <li>üìç Direcci√≥n de ejemplo 123</li>
                        <li>üìû +56 9 1234 5678</li>
                        <li>‚úâÔ∏è contacto@mitienda.cl</li>
                    </ul>
                </div>

                <div class="footer-section footer-legal">
                    <h4 class="footer-title">Legal</h4>
                    <ul>
                        <li><a href="privacidad.html">Privacidad</a></li>
                        <li><a href="terminos.html">T√©rminos</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Mi Tienda. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Social Float -->
    <div class="social-float-container" id="socialFloat">
        <a class="social-float social-whatsapp" href="https://wa.me/56912345678" target="_blank" rel="noopener" aria-label="WhatsApp">
            <span class="social-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M20.52 3.48A11.86 11.86 0 0 0 12.06 0C5.5 0 .18 5.32.18 11.88c0 2.1.55 4.15 1.6 5.97L0 24l6.32-1.74a11.86 11.86 0 0 0 5.74 1.46h.01c6.56 0 11.88-5.33 11.88-11.89 0-3.18-1.24-6.16-3.43-8.35Z" />
                </svg>
            </span>
            <span class="social-text">WhatsApp</span>
        </a>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js?v=3.0"></script>
    <script src="../js/utils.js?v=3.0"></script>
    <script src="../js/auth.js?v=3.0"></script>
    <script src="../js/cart.js?v=3.0"></script>
    <script src="../js/api.js?v=3.0"></script>
    <script src="../js/header.js?v=3.0"></script>
    <script src="../js/wishlist.js?v=3.0"></script>
    <script src="../js/script.js?v=3.0"></script>
    <script>
        let appliedDiscount = 0;
        let discountCode = null;

        function renderCarrito() {
            const container = document.getElementById('carritoItems');
            const items = cart.getAll();
            const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);

            // Update header count
            document.getElementById('cartItemCount').textContent =
                `${totalItems} ${totalItems === 1 ? 'producto' : 'productos'}`;
            document.getElementById('summaryItemCount').textContent = totalItems;

            // Show/hide clear button
            const clearBtn = document.getElementById('clearCartBtn');
            clearBtn.style.display = items.length > 0 ? 'flex' : 'none';

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="carrito-empty">
                        <svg class="empty-icon" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                        </svg>
                        <h2>Tu carrito est√° vac√≠o</h2>
                        <p>Agrega algunos productos para comenzar tu compra</p>
                        <a href="productos.html" class="btn btn-primary">Ver Productos</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => {
                const itemSubtotal = item.price * item.quantity;
                const hasDiscount = item.originalPrice && item.originalPrice > item.price;
                const discountPercent = hasDiscount ? Math.round((1 - item.price / item.originalPrice) * 100) : 0;

                return `
                <article class="carrito-item" data-id="${item.product_id}">
                    <div class="item-image">
                        <img src="${item.image_url || '../images/products/placeholder.png'}" alt="${escapeHtml(item.name)}" loading="lazy">
                    </div>
                    
                    <div class="item-info">
                        <h3 class="item-name">${escapeHtml(item.name)}</h3>
                        ${item.brand ? `<span class="item-brand">${escapeHtml(item.brand)}</span>` : ''}
                        ${item.category ? `<span class="item-category">${escapeHtml(item.category)}</span>` : ''}
                        
                        <div class="item-price-info">
                            ${hasDiscount ? `
                                <span class="original-price">${formatPrice(item.originalPrice)}</span>
                                <span class="offer-price">${formatPrice(item.price)}</span>
                                <span class="discount-badge">-${discountPercent}%</span>
                            ` : `
                                <span class="regular-price">${formatPrice(item.price)}</span>
                            `}
                        </div>
                    </div>
                    
                    <div class="item-controls">
                        <div class="quantity-section">
                            <label>Cantidad:</label>
                            <div class="quantity-controls">
                                <button class="qty-btn decrease" onclick="updateQty('${item.product_id}', -1)">‚àí</button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="qty-btn increase" onclick="updateQty('${item.product_id}', 1)" ${item.stock && item.quantity >= item.stock ? 'disabled' : ''}>+</button>
                            </div>
                            ${item.stock ? `<span class="stock-info">Stock: ${item.stock}</span>` : ''}
                        </div>
                        
                        <div class="item-total">
                            <label>Subtotal:</label>
                            <span class="subtotal-price">${formatPrice(itemSubtotal)}</span>
                        </div>
                        
                        <button class="btn-remove-item" onclick="removeItem('${item.product_id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Eliminar
                        </button>
                    </div>
                </article>
            `}).join('');

            updateSummary();
        }

        function updateQty(id, delta) {
            const item = cart.getAll().find(i => i.product_id === id);
            if (item) {
                const newQty = item.quantity + delta;
                if (newQty <= 0) {
                    removeItem(id);
                } else {
                    cart.updateQuantity(id, newQty);
                    renderCarrito();
                }
            }
        }

        function removeItem(id) {
            cart.remove(id);
            renderCarrito();
        }

        function clearCart() {
            if (confirm('¬øEst√°s seguro de vaciar el carrito?')) {
                cart.clear();
                renderCarrito();
            }
        }

        function updateSummary() {
            const subtotal = cart.getSubtotal();
            const total = cart.getTotal(appliedDiscount);
            const freeShipping = subtotal >= 50000;

            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('total').textContent = formatPrice(total);
            document.getElementById('shippingCost').textContent = freeShipping ? 'Gratis' : 'Por calcular';
            document.getElementById('shippingCost').classList.toggle('free-shipping', freeShipping);

            if (appliedDiscount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('discountAmount').textContent = '-' + formatPrice(appliedDiscount);
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }
        }

        // Clear cart button
        document.getElementById('clearCartBtn').addEventListener('click', clearCart);

        // Discount code
        document.getElementById('applyDiscount').addEventListener('click', async () => {
            const code = document.getElementById('discountCode').value.trim();
            if (!code) return;

            try {
                const result = await api.validateDiscountCode(code);
                if (result.valid) {
                    discountCode = result.code;
                    const subtotal = cart.getSubtotal();

                    if (result.discount_type === 'percentage') {
                        appliedDiscount = Math.round(subtotal * (result.discount_value / 100));
                    } else {
                        appliedDiscount = result.discount_value;
                    }

                    updateSummary();
                    showNotification(`C√≥digo ${result.code} aplicado: ${result.discount_value}${result.discount_type === 'percentage' ? '%' : ''} de descuento`, 'success');
                }
            } catch (error) {
                showNotification(error.message || 'C√≥digo no v√°lido', 'error');
            }
        });

        // Checkout
        document.getElementById('checkoutBtn').addEventListener('click', async () => {
            if (!isLoggedIn()) {
                showNotification('Debes iniciar sesi√≥n para continuar', 'warning');
                setTimeout(() => window.location.href = 'login.html', 1000);
                return;
            }

            if (cart.isEmpty()) {
                showNotification('Tu carrito est√° vac√≠o', 'error');
                return;
            }

            try {
                const result = await api.createTransaction({
                    items: cart.getItemsForApi(),
                    discount_code: discountCode,
                    discount_amount: appliedDiscount
                });

                const paymentResult = await api.webpayCreate(result.order_id);

                if (paymentResult.url && paymentResult.token) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = paymentResult.url;

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'token_ws';
                    input.value = paymentResult.token;

                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }
            } catch (error) {
                showNotification(error.message || 'Error al procesar el pago', 'error');
            }
        });

        document.addEventListener('DOMContentLoaded', renderCarrito);
        document.addEventListener('cartUpdated', renderCarrito);
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos | Mi Tienda</title>
    <meta name="description" content="Revisa el historial de tus pedidos en Mi Tienda.">
    <meta name="robots" content="noindex, nofollow">

    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="stylesheet" href="/css/main.css?v=7.0">
    <link rel="stylesheet" href="/css/pages/mis-pedidos.css?v=7.0">
    <link rel="stylesheet" href="/css/components/mini-cart.css?v=7.0">
</head>

<body>
    <a href="#main" class="skip-link">Ir al contenido principal</a>

    <!-- Simple Header -->
    <header class="page-header">
        <div class="container">
            <a href="/home.html" class="page-logo">
                <span class="logo-icon">MT</span>
                <span class="logo-text">Mi Tienda</span>
            </a>
            <nav class="page-nav">
                <a href="productos.html">Productos</a>
                <a href="cuenta.html">Mi Cuenta</a>
                <a href="carrito.html" class="cart-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1" />
                        <circle cx="20" cy="21" r="1" />
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                    </svg>
                    <span class="cart-count" id="cartCount" style="display: none;">0</span>
                </a>
            </nav>
        </div>
    </header>

    <main id="main" class="orders-main">
        <div class="container">
            <!-- Page Header -->
            <div class="orders-page-header">
                <h1>
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <path d="M16 10a4 4 0 0 1-8 0"/>
                    </svg>
                    Mis Pedidos
                </h1>
                <p>Revisa el estado e historial de tus compras</p>
            </div>

            <!-- Stats Cards -->
            <div class="orders-stats" id="ordersStats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                            <line x1="3" y1="6" x2="21" y2="6"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="totalOrders">0</span>
                        <span class="stat-label">Total Pedidos</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon pending">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="pendingOrders">0</span>
                        <span class="stat-label">En Proceso</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon completed">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="completedOrders">0</span>
                        <span class="stat-label">Completados</span>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="orders-filters">
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all">Todos</button>
                    <button class="filter-tab" data-filter="pending">Pendientes</button>
                    <button class="filter-tab" data-filter="processing">En Proceso</button>
                    <button class="filter-tab" data-filter="shipped">Enviados</button>
                    <button class="filter-tab" data-filter="completed">Completados</button>
                </div>
                <div class="filter-search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" id="searchOrders" placeholder="Buscar por # de orden o producto...">
                </div>
            </div>

            <!-- Orders List -->
            <div class="orders-list" id="ordersList">
                <div class="orders-loading">
                    <div class="spinner"></div>
                    <p>Cargando pedidos...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div class="orders-empty" id="ordersEmpty" style="display: none;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <path d="M16 10a4 4 0 0 1-8 0"/>
                </svg>
                <h2>No tienes pedidos a√∫n</h2>
                <p>Cuando realices una compra, aparecer√° aqu√≠.</p>
                <a href="productos.html" class="btn btn-primary">
                    Ver Productos
                </a>
            </div>

            <!-- Pagination -->
            <div class="orders-pagination" id="ordersPagination" style="display: none;">
                <button class="btn-page" id="prevPage" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    Anterior
                </button>
                <span class="page-info" id="pageInfo">P√°gina 1 de 1</span>
                <button class="btn-page" id="nextPage" disabled>
                    Siguiente
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Order Detail Modal -->
    <div class="order-modal" id="orderModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalle del Pedido <span id="modalOrderId"></span></h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="page-footer">
        <div class="container">
            <p>&copy; 2025 Mi Tienda. Todos los derechos reservados.</p>
            <div class="footer-links">
                <a href="terminos.html">T√©rminos</a>
                <a href="privacidad.html">Privacidad</a>
                <a href="contacto.html">Contacto</a>
            </div>
        </div>
    </footer>

    <script src="/js/config.js?v=7.0"></script>
    <script src="/js/utils.js?v=7.0"></script>
    <script src="/js/auth.js?v=7.0"></script>
    <script src="/js/cart.js?v=7.0"></script>
    <script src="/js/api.js?v=7.0"></script>
    <script>
        (function() {
            'use strict';

            // State
            let orders = [];
            let filteredOrders = [];
            let currentPage = 1;
            let currentFilter = 'all';
            const ORDERS_PER_PAGE = 10;

            // Check authentication
            if (typeof isLoggedIn === 'function' && !isLoggedIn()) {
                window.location.href = 'login.html?redirect=mis-pedidos.html';
                return;
            }

            // Initialize
            document.addEventListener('DOMContentLoaded', init);

            async function init() {
                await loadOrders();
                bindEvents();
                updateCartCount();
            }

            async function loadOrders() {
                try {
                    const response = await api.getUserTransactions();
                    orders = Array.isArray(response) ? response : (response.transactions || []);
                    
                    // Sort by date descending
                    orders.sort((a, b) => new Date(b.createdAt || b.created_at) - new Date(a.createdAt || a.created_at));
                    
                    updateStats();
                    filterOrders();
                } catch (error) {
                    console.error('Error loading orders:', error);
                    document.getElementById('ordersList').innerHTML = `
                        <div class="orders-error">
                            <p>Error al cargar pedidos. <button onclick="location.reload()">Reintentar</button></p>
                        </div>
                    `;
                }
            }

            function bindEvents() {
                // Filter tabs
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        currentFilter = tab.dataset.filter;
                        currentPage = 1;
                        filterOrders();
                    });
                });

                // Search
                document.getElementById('searchOrders')?.addEventListener('input', debounce((e) => {
                    currentPage = 1;
                    filterOrders();
                }, 300));

                // Pagination
                document.getElementById('prevPage')?.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderOrders();
                    }
                });

                document.getElementById('nextPage')?.addEventListener('click', () => {
                    const totalPages = Math.ceil(filteredOrders.length / ORDERS_PER_PAGE);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderOrders();
                    }
                });

                // Modal close
                document.getElementById('closeModal')?.addEventListener('click', closeModal);
                document.querySelector('.modal-backdrop')?.addEventListener('click', closeModal);
            }

            function updateStats() {
                const stats = {
                    total: orders.length,
                    pending: orders.filter(o => ['pending', 'processing'].includes(o.status)).length,
                    completed: orders.filter(o => ['completed', 'delivered'].includes(o.status)).length
                };

                document.getElementById('totalOrders').textContent = stats.total;
                document.getElementById('pendingOrders').textContent = stats.pending;
                document.getElementById('completedOrders').textContent = stats.completed;
            }

            function filterOrders() {
                const searchTerm = document.getElementById('searchOrders')?.value.toLowerCase().trim() || '';

                filteredOrders = orders.filter(order => {
                    // Filter by status
                    if (currentFilter !== 'all') {
                        const statusMap = {
                            pending: ['pending', 'awaiting_payment'],
                            processing: ['processing', 'confirmed'],
                            shipped: ['shipped', 'in_transit'],
                            completed: ['completed', 'delivered']
                        };
                        if (!statusMap[currentFilter]?.includes(order.status)) return false;
                    }

                    // Filter by search
                    if (searchTerm) {
                        const orderId = (order.id || order.order_id || '').toLowerCase();
                        const items = order.items || [];
                        const matchesId = orderId.includes(searchTerm);
                        const matchesProduct = items.some(item => 
                            (item.name || item.nombre || '').toLowerCase().includes(searchTerm)
                        );
                        if (!matchesId && !matchesProduct) return false;
                    }

                    return true;
                });

                renderOrders();
            }

            function renderOrders() {
                const container = document.getElementById('ordersList');
                const emptyState = document.getElementById('ordersEmpty');
                const pagination = document.getElementById('ordersPagination');

                if (filteredOrders.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'flex';
                    pagination.style.display = 'none';
                    return;
                }

                emptyState.style.display = 'none';

                // Pagination
                const totalPages = Math.ceil(filteredOrders.length / ORDERS_PER_PAGE);
                const startIndex = (currentPage - 1) * ORDERS_PER_PAGE;
                const endIndex = startIndex + ORDERS_PER_PAGE;
                const pageOrders = filteredOrders.slice(startIndex, endIndex);

                container.innerHTML = pageOrders.map(order => createOrderCard(order)).join('');

                // Bind view details buttons
                container.querySelectorAll('.btn-view-order').forEach(btn => {
                    btn.addEventListener('click', () => showOrderDetail(btn.dataset.orderId));
                });

                // Update pagination
                if (totalPages > 1) {
                    pagination.style.display = 'flex';
                    document.getElementById('pageInfo').textContent = `P√°gina ${currentPage} de ${totalPages}`;
                    document.getElementById('prevPage').disabled = currentPage <= 1;
                    document.getElementById('nextPage').disabled = currentPage >= totalPages;
                } else {
                    pagination.style.display = 'none';
                }
            }

            function createOrderCard(order) {
                const orderId = order.id || order.order_id || 'N/A';
                const date = formatDate(order.createdAt || order.created_at);
                const status = order.status || 'pending';
                const statusInfo = getStatusInfo(status);
                const total = order.total || 0;
                const items = order.items || [];

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">
                                <span class="label">Pedido</span>
                                <span class="value">#${escapeHtml(orderId.slice(-8).toUpperCase())}</span>
                            </div>
                            <div class="order-date">${date}</div>
                        </div>
                        <div class="order-status">
                            <span class="status-badge status-${status}">
                                ${statusInfo.icon}
                                ${statusInfo.label}
                            </span>
                        </div>
                        <div class="order-items">
                            ${items.slice(0, 3).map(item => `
                                <div class="order-item-mini">
                                    <span class="item-qty">${item.quantity}x</span>
                                    <span class="item-name">${escapeHtml(item.name || item.nombre || 'Producto')}</span>
                                </div>
                            `).join('')}
                            ${items.length > 3 ? `<span class="more-items">+${items.length - 3} m√°s</span>` : ''}
                        </div>
                        <div class="order-footer">
                            <div class="order-total">
                                <span class="label">Total</span>
                                <span class="value">${formatPrice(total)}</span>
                            </div>
                            <button class="btn-view-order" data-order-id="${orderId}">
                                Ver Detalle
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }

            function showOrderDetail(orderId) {
                const order = orders.find(o => (o.id || o.order_id) === orderId);
                if (!order) return;

                const modal = document.getElementById('orderModal');
                const modalBody = document.getElementById('modalBody');
                const statusInfo = getStatusInfo(order.status);

                document.getElementById('modalOrderId').textContent = '#' + orderId.slice(-8).toUpperCase();

                modalBody.innerHTML = `
                    <div class="order-detail">
                        <div class="detail-section">
                            <h4>Estado del Pedido</h4>
                            <div class="status-timeline">
                                <div class="timeline-item ${['pending', 'processing', 'shipped', 'completed', 'delivered'].includes(order.status) ? 'active' : ''}">
                                    <div class="timeline-dot"></div>
                                    <span>Pedido Recibido</span>
                                </div>
                                <div class="timeline-item ${['processing', 'shipped', 'completed', 'delivered'].includes(order.status) ? 'active' : ''}">
                                    <div class="timeline-dot"></div>
                                    <span>En Preparaci√≥n</span>
                                </div>
                                <div class="timeline-item ${['shipped', 'completed', 'delivered'].includes(order.status) ? 'active' : ''}">
                                    <div class="timeline-dot"></div>
                                    <span>Enviado</span>
                                </div>
                                <div class="timeline-item ${['completed', 'delivered'].includes(order.status) ? 'active' : ''}">
                                    <div class="timeline-dot"></div>
                                    <span>Entregado</span>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>Productos</h4>
                            <div class="detail-items">
                                ${(order.items || []).map(item => `
                                    <div class="detail-item">
                                        <div class="item-image">
                                            <img src="${item.image || item.image_url || '/images/products/placeholder.png'}" alt="${escapeHtml(item.name || item.nombre)}">
                                        </div>
                                        <div class="item-info">
                                            <span class="item-name">${escapeHtml(item.name || item.nombre || 'Producto')}</span>
                                            <span class="item-qty">Cantidad: ${item.quantity}</span>
                                        </div>
                                        <div class="item-price">${formatPrice(item.price * item.quantity)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>Resumen</h4>
                            <div class="detail-summary">
                                <div class="summary-row">
                                    <span>Subtotal</span>
                                    <span>${formatPrice(order.subtotal || order.total)}</span>
                                </div>
                                ${order.shipping_cost ? `
                                    <div class="summary-row">
                                        <span>Env√≠o</span>
                                        <span>${formatPrice(order.shipping_cost)}</span>
                                    </div>
                                ` : ''}
                                ${order.discount ? `
                                    <div class="summary-row discount">
                                        <span>Descuento</span>
                                        <span>-${formatPrice(order.discount)}</span>
                                    </div>
                                ` : ''}
                                <div class="summary-row total">
                                    <span>Total</span>
                                    <span>${formatPrice(order.total)}</span>
                                </div>
                            </div>
                        </div>

                        ${order.shipping_address ? `
                            <div class="detail-section">
                                <h4>Direcci√≥n de Env√≠o</h4>
                                <p>${escapeHtml(order.shipping_address)}</p>
                            </div>
                        ` : ''}

                        <div class="detail-actions">
                            ${order.status === 'completed' || order.status === 'delivered' ? `
                                <button class="btn btn-outline" onclick="reorderItems('${orderId}')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="23 4 23 10 17 10"/>
                                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                    </svg>
                                    Volver a Comprar
                                </button>
                            ` : ''}
                            <a href="contacto.html?subject=Pedido%20${orderId}" class="btn btn-outline">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                                Contactar Soporte
                            </a>
                        </div>
                    </div>
                `;

                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                document.getElementById('orderModal').classList.remove('active');
                document.body.style.overflow = '';
            }

            window.reorderItems = async function(orderId) {
                const order = orders.find(o => (o.id || o.order_id) === orderId);
                if (!order || !order.items) return;

                order.items.forEach(item => {
                    if (typeof cart !== 'undefined' && typeof cart.add === 'function') {
                        cart.add({
                            id: item.product_id || item.id,
                            name: item.name || item.nombre,
                            price: item.price,
                            quantity: item.quantity,
                            image_url: item.image || item.image_url
                        });
                    }
                });

                closeModal();
                showNotification('Productos agregados al carrito', 'success');
            };

            function getStatusInfo(status) {
                const statuses = {
                    pending: { label: 'Pendiente', icon: '‚è≥' },
                    awaiting_payment: { label: 'Esperando Pago', icon: 'üí≥' },
                    processing: { label: 'Procesando', icon: 'üîÑ' },
                    confirmed: { label: 'Confirmado', icon: '‚úì' },
                    shipped: { label: 'Enviado', icon: 'üöö' },
                    in_transit: { label: 'En Tr√°nsito', icon: 'üì¶' },
                    completed: { label: 'Completado', icon: '‚úÖ' },
                    delivered: { label: 'Entregado', icon: '‚úÖ' },
                    cancelled: { label: 'Cancelado', icon: '‚ùå' },
                    refunded: { label: 'Reembolsado', icon: '‚Ü©Ô∏è' }
                };
                return statuses[status] || { label: status, icon: '‚Ä¢' };
            }

            function formatDate(date) {
                if (!date) return 'N/A';
                return new Date(date).toLocaleDateString('es-CL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            function formatPrice(price) {
                return '$' + new Intl.NumberFormat('es-CL').format(price || 0);
            }

            function escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            function updateCartCount() {
                if (typeof cart !== 'undefined') {
                    const count = cart.getCount();
                    const countEl = document.getElementById('cartCount');
                    if (countEl) {
                        countEl.textContent = count;
                        countEl.style.display = count > 0 ? 'flex' : 'none';
                    }
                }
            }

            function showNotification(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `notification-toast notification-${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    background: ${type === 'success' ? '#28a745' : '#667eea'};
                    color: white;
                    font-size: 14px;
                    z-index: 10000;
                `;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        })();
    </script>
</body>

</html>

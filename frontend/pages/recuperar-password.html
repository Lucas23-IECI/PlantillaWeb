<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña | Mi Tienda</title>
    <meta name="description" content="Recupera tu contraseña de Mi Tienda. Te enviaremos instrucciones a tu email.">
    <meta name="robots" content="noindex, nofollow">

    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="stylesheet" href="/css/main.css?v=7.0">
    <link rel="stylesheet" href="/css/pages/cuenta.css?v=7.0">
</head>

<body class="auth-page">
    <a href="#main" class="skip-link">Ir al contenido principal</a>

    <main id="main" class="auth-container">
        <div class="auth-card">
            <!-- Logo -->
            <a href="/home.html" class="auth-logo">
                <span class="logo-icon">MT</span>
                <span class="logo-text">Mi Tienda</span>
            </a>

            <!-- Request Reset Form -->
            <div id="requestForm">
                <h1>Recuperar Contraseña</h1>
                <p class="auth-subtitle">Ingresa tu email y te enviaremos instrucciones para restablecer tu contraseña.</p>

                <form id="recoveryForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label" for="email">Email</label>
                        <div class="input-with-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            <input type="email" class="form-input" id="email" name="email" required placeholder="tu@email.com" autocomplete="email">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg btn-full" id="submitBtn">
                        <span class="btn-text">Enviar Instrucciones</span>
                        <span class="btn-loading" style="display: none;">
                            <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10">
                                    <animateTransform attributeName="transform" type="rotate" dur="1s" from="0 12 12" to="360 12 12" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            Enviando...
                        </span>
                    </button>
                </form>

                <p class="auth-link">
                    <a href="login.html">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Volver a Iniciar Sesión
                    </a>
                </p>
            </div>

            <!-- Success Message -->
            <div id="successMessage" style="display: none;">
                <div class="success-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <h1>¡Revisa tu Email!</h1>
                <p class="auth-subtitle">Hemos enviado las instrucciones de recuperación a <strong id="sentEmail"></strong></p>
                <div class="info-box">
                    <h4>¿No ves el email?</h4>
                    <ul>
                        <li>Revisa tu carpeta de spam o correo no deseado</li>
                        <li>Asegúrate de haber ingresado el email correcto</li>
                        <li>El email puede tardar unos minutos en llegar</li>
                    </ul>
                </div>
                <button class="btn btn-outline btn-lg btn-full" id="resendBtn">
                    Reenviar Email
                </button>
                <p class="auth-link">
                    <a href="login.html">Volver a Iniciar Sesión</a>
                </p>
            </div>

            <!-- Reset Password Form (shown when token is present in URL) -->
            <div id="resetForm" style="display: none;">
                <h1>Nueva Contraseña</h1>
                <p class="auth-subtitle">Ingresa tu nueva contraseña.</p>

                <form id="newPasswordForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label" for="newPassword">Nueva Contraseña</label>
                        <div class="input-with-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            <input type="password" class="form-input" id="newPassword" name="newPassword" required minlength="8" placeholder="Mínimo 8 caracteres">
                            <button type="button" class="toggle-password" aria-label="Mostrar contraseña">
                                <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                    <line x1="1" y1="1" x2="23" y2="23"/>
                                </svg>
                            </button>
                        </div>
                        <div class="password-strength" id="passwordStrength">
                            <div class="strength-bar"><div class="strength-fill"></div></div>
                            <span class="strength-text">Seguridad de la contraseña</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirmar Contraseña</label>
                        <div class="input-with-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            <input type="password" class="form-input" id="confirmPassword" name="confirmPassword" required placeholder="Repite tu contraseña">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg btn-full" id="resetSubmitBtn">
                        <span class="btn-text">Cambiar Contraseña</span>
                        <span class="btn-loading" style="display: none;">
                            <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10">
                                    <animateTransform attributeName="transform" type="rotate" dur="1s" from="0 12 12" to="360 12 12" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            Guardando...
                        </span>
                    </button>
                </form>
            </div>

            <!-- Reset Success -->
            <div id="resetSuccess" style="display: none;">
                <div class="success-icon success">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <h1>¡Contraseña Actualizada!</h1>
                <p class="auth-subtitle">Tu contraseña ha sido cambiada exitosamente. Ya puedes iniciar sesión con tu nueva contraseña.</p>
                <a href="login.html" class="btn btn-primary btn-lg btn-full">
                    Iniciar Sesión
                </a>
            </div>
        </div>
    </main>

    <script src="/js/config.js?v=7.0"></script>
    <script src="/js/api.js?v=7.0"></script>
    <script>
        (function() {
            'use strict';

            let currentEmail = '';

            // Check for reset token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');

            if (resetToken) {
                document.getElementById('requestForm').style.display = 'none';
                document.getElementById('resetForm').style.display = 'block';
            }

            // Recovery form submission
            document.getElementById('recoveryForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim();
                const btn = document.getElementById('submitBtn');
                
                if (!email) {
                    showNotification('Por favor ingresa tu email', 'error');
                    return;
                }

                setLoading(btn, true);

                try {
                    const response = await fetch(`${window.CONFIG?.API_URL || '/api'}/auth/forgot-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        currentEmail = email;
                        document.getElementById('sentEmail').textContent = email;
                        document.getElementById('requestForm').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                    } else {
                        showNotification(result.message || 'Error al enviar email', 'error');
                    }
                } catch (error) {
                    // Even if error, show success to prevent email enumeration
                    currentEmail = email;
                    document.getElementById('sentEmail').textContent = email;
                    document.getElementById('requestForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                } finally {
                    setLoading(btn, false);
                }
            });

            // Resend email
            document.getElementById('resendBtn')?.addEventListener('click', async () => {
                const btn = document.getElementById('resendBtn');
                btn.disabled = true;
                btn.textContent = 'Enviando...';

                try {
                    await fetch(`${window.CONFIG?.API_URL || '/api'}/auth/forgot-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: currentEmail })
                    });

                    showNotification('Email reenviado', 'success');
                    btn.textContent = 'Email Reenviado';
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = 'Reenviar Email';
                    }, 30000);
                } catch (error) {
                    btn.disabled = false;
                    btn.textContent = 'Reenviar Email';
                }
            });

            // New password form
            document.getElementById('newPasswordForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const password = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const btn = document.getElementById('resetSubmitBtn');

                if (password.length < 8) {
                    showNotification('La contraseña debe tener al menos 8 caracteres', 'error');
                    return;
                }

                if (password !== confirmPassword) {
                    showNotification('Las contraseñas no coinciden', 'error');
                    return;
                }

                setLoading(btn, true);

                try {
                    const response = await fetch(`${window.CONFIG?.API_URL || '/api'}/auth/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: resetToken, password })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        document.getElementById('resetForm').style.display = 'none';
                        document.getElementById('resetSuccess').style.display = 'block';
                    } else {
                        showNotification(result.message || 'Error al cambiar contraseña', 'error');
                    }
                } catch (error) {
                    showNotification('Error de conexión', 'error');
                } finally {
                    setLoading(btn, false);
                }
            });

            // Password visibility toggle
            document.querySelectorAll('.toggle-password').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = btn.parentElement.querySelector('input');
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                    btn.querySelector('.eye-open').style.display = isPassword ? 'none' : 'block';
                    btn.querySelector('.eye-closed').style.display = isPassword ? 'block' : 'none';
                });
            });

            // Password strength indicator
            document.getElementById('newPassword')?.addEventListener('input', (e) => {
                const password = e.target.value;
                const strength = calculatePasswordStrength(password);
                updateStrengthIndicator(strength);
            });

            function calculatePasswordStrength(password) {
                let score = 0;
                if (password.length >= 8) score++;
                if (password.length >= 12) score++;
                if (/[a-z]/.test(password)) score++;
                if (/[A-Z]/.test(password)) score++;
                if (/[0-9]/.test(password)) score++;
                if (/[^a-zA-Z0-9]/.test(password)) score++;
                return Math.min(score, 4);
            }

            function updateStrengthIndicator(score) {
                const indicator = document.getElementById('passwordStrength');
                const fill = indicator.querySelector('.strength-fill');
                const text = indicator.querySelector('.strength-text');

                const levels = [
                    { width: '0%', color: '#ddd', label: 'Muy débil' },
                    { width: '25%', color: '#e94560', label: 'Débil' },
                    { width: '50%', color: '#ffc107', label: 'Regular' },
                    { width: '75%', color: '#17a2b8', label: 'Buena' },
                    { width: '100%', color: '#28a745', label: 'Excelente' }
                ];

                const level = levels[score];
                fill.style.width = level.width;
                fill.style.background = level.color;
                text.textContent = level.label;
                text.style.color = level.color;
            }

            function setLoading(btn, loading) {
                btn.disabled = loading;
                btn.querySelector('.btn-text').style.display = loading ? 'none' : 'inline';
                btn.querySelector('.btn-loading').style.display = loading ? 'inline-flex' : 'none';
            }

            function showNotification(message, type = 'info') {
                // Simple notification
                const existing = document.querySelector('.notification-toast');
                if (existing) existing.remove();

                const toast = document.createElement('div');
                toast.className = `notification-toast notification-${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    background: ${type === 'error' ? '#e94560' : type === 'success' ? '#28a745' : '#667eea'};
                    color: white;
                    font-size: 14px;
                    z-index: 10000;
                    animation: slideIn 0.3s ease-out;
                `;

                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }
        })();
    </script>

    <style>
        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            padding: var(--spacing-lg);
        }

        .auth-container {
            width: 100%;
            max-width: 440px;
        }

        .auth-card {
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-xl);
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            color: var(--color-text);
            margin-bottom: var(--spacing-xl);
        }

        .auth-logo .logo-icon {
            background: var(--color-primary);
            color: white;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-xl);
        }

        .auth-logo .logo-text {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .auth-card h1 {
            text-align: center;
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-2xl);
        }

        .auth-subtitle {
            text-align: center;
            color: var(--color-text-light);
            margin-bottom: var(--spacing-xl);
            line-height: 1.6;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-icon > svg {
            position: absolute;
            left: var(--spacing-md);
            color: var(--color-text-muted);
        }

        .input-with-icon input {
            padding-left: 48px;
            width: 100%;
        }

        .toggle-password {
            position: absolute;
            right: var(--spacing-md);
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0;
        }

        .btn-full {
            width: 100%;
        }

        .btn-loading {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .auth-link {
            text-align: center;
            margin-top: var(--spacing-lg);
        }

        .auth-link a {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--color-text-light);
            text-decoration: none;
            font-size: var(--font-size-sm);
            transition: color var(--transition-fast);
        }

        .auth-link a:hover {
            color: var(--color-accent);
        }

        .success-icon {
            text-align: center;
            margin-bottom: var(--spacing-lg);
            color: var(--color-primary);
        }

        .success-icon.success {
            color: var(--color-success);
        }

        .info-box {
            background: var(--color-background-alt);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin: var(--spacing-xl) 0;
        }

        .info-box h4 {
            margin: 0 0 var(--spacing-sm);
            font-size: var(--font-size-sm);
        }

        .info-box ul {
            margin: 0;
            padding-left: var(--spacing-lg);
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
        }

        .info-box li {
            margin-bottom: var(--spacing-xs);
        }

        .password-strength {
            margin-top: var(--spacing-sm);
        }

        .strength-bar {
            height: 4px;
            background: var(--color-background-alt);
            border-radius: 2px;
            overflow: hidden;
        }

        .strength-fill {
            height: 100%;
            width: 0;
            transition: all var(--transition-normal);
        }

        .strength-text {
            display: block;
            margin-top: var(--spacing-xs);
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</body>

</html>

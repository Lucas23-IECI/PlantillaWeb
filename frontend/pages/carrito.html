<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Carrito | Mi Tienda</title>
    <meta name="description" content="Tu carrito de compras en Mi Tienda. Revisa tus productos y procede al pago.">

    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css?v=6.5">
    <link rel="stylesheet" href="/css/components/wishlist.css?v=6.5">
    <link rel="stylesheet" href="/css/pages/carrito.css?v=6.5">
</head>

<body>
    <a href="#main" class="skip-link">Ir al contenido principal</a>

    <!-- Header -->
    <header class="header-container">
        <div class="header-info">
            <p>Env√≠o gratis en compras sobre $50.000 | Lunes a Viernes 9:00 - 18:00hrs</p>
        </div>

        <nav class="header-nav">
            <div class="container">
                <button class="menu-toggle" aria-label="Men√∫">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12" />
                        <line x1="3" y1="6" x2="21" y2="6" />
                        <line x1="3" y1="18" x2="21" y2="18" />
                    </svg>
                </button>

                <a href="/home.html" class="header-logo">MT</a>

                <ul class="nav-links">
                    <li><a href="/home.html">Inicio</a></li>
                    <li><a href="productos.html">Productos</a></li>
                    <li><a href="nosotros.html">Nosotros</a></li>
                    <li><a href="contacto.html">Contacto</a></li>
                </ul>

                <div class="header-search">
                    <button class="search-icon" aria-label="Buscar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                    </button>
                    <input type="text" placeholder="Buscar productos...">
                </div>

                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">
                        <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>

                    <a href="wishlist.html" class="wishlist-header-btn" aria-label="Favoritos">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                        </svg>
                        <span class="wishlist-count" style="display:none;">0</span>
                    </a>

                    <a href="carrito.html" class="cart-btn active" aria-label="Carrito">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                        </svg>
                        <span class="cart-count" id="cartCount" style="display:none;">0</span>
                    </a>

                    <a href="login.html" class="user-btn" aria-label="Usuario">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <span>Men√∫</span>
            <button class="mobile-close" aria-label="Cerrar">&times;</button>
        </div>
        <nav class="mobile-nav">
            <a href="/home.html">Inicio</a>
            <a href="productos.html">Productos</a>
            <a href="nosotros.html">Nosotros</a>
            <a href="contacto.html">Contacto</a>
            <a href="login.html">Ingresar</a>
        </nav>
    </div>
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Main Content -->
    <main id="main" class="cart-main">
        <div class="container">
            <!-- Page Header -->
            <div class="cart-page-header">
                <div class="cart-title-section">
                    <h1>
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                        </svg>
                        Tu Carrito
                        <span class="cart-item-count" id="cartBadge">(0 productos)</span>
                    </h1>
                </div>
                <div class="cart-actions" id="cartActions">
                    <a href="productos.html" class="btn-action">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6" />
                        </svg>
                        <span>Seguir comprando</span>
                    </a>
                    <button class="btn-action btn-danger" id="clearCartBtn" title="Vaciar carrito">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6" />
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                        </svg>
                        <span>Vaciar</span>
                    </button>
                </div>
            </div>

            <!-- Cart Grid -->
            <div class="cart-grid" id="cartGrid">
                <!-- Cart Items -->
                <div class="cart-items-container" id="cartItems">
                    <!-- Dynamic content rendered by JS -->
                </div>

                <!-- Order Summary -->
                <div class="cart-summary" id="cartSummary">
                    <div class="summary-header">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2" />
                            <rect x="9" y="3" width="6" height="4" rx="1" />
                        </svg>
                        <h2>Finalizar Compra</h2>
                    </div>

                    <!-- Checkout Form -->
                    <form id="checkoutForm" class="checkout-form" autocomplete="on">
                        
                        <!-- Card 1: Contact Data -->
                        <div class="checkout-card">
                            <div class="checkout-card-header">
                                <span class="checkout-card-number">1</span>
                                <h3 class="checkout-card-title">Datos de Contacto</h3>
                            </div>
                            <div class="checkout-card-body">
                                <div class="checkout-field">
                                    <label for="customerName">Nombre completo</label>
                                    <input type="text" id="customerName" name="name" required autocomplete="name" placeholder="Juan P√©rez">
                                    <span class="field-error" id="customerNameError"></span>
                                </div>
                                <div class="checkout-field-row">
                                    <div class="checkout-field">
                                        <label for="customerPhone">Tel√©fono</label>
                                        <input type="tel" id="customerPhone" name="phone" required autocomplete="tel" placeholder="+56 9 1234 5678">
                                        <span class="field-error" id="customerPhoneError"></span>
                                    </div>
                                    <div class="checkout-field">
                                        <label for="customerEmail">Email <span class="optional-tag">(opcional)</span></label>
                                        <input type="email" id="customerEmail" name="email" autocomplete="email" placeholder="correo@ejemplo.com">
                                    </div>
                                </div>
                                <div class="checkout-save-data">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="saveUserData" name="save_data">
                                        <span class="checkbox-custom"></span>
                                        <span class="checkbox-text">Guardar mis datos para pr√≥ximas compras</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: Delivery Method -->
                        <div class="checkout-card">
                            <div class="checkout-card-header">
                                <span class="checkout-card-number">2</span>
                                <h3 class="checkout-card-title">M√©todo de Entrega</h3>
                            </div>
                            <div class="checkout-card-body">
                                <div class="delivery-options">
                                    <label class="delivery-option" data-option="pickup">
                                        <input type="radio" name="delivery_method" value="pickup" checked>
                                        <div class="delivery-option-content">
                                            <div class="delivery-option-icon">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                </svg>
                                            </div>
                                            <div class="delivery-option-info">
                                                <span class="delivery-option-title">Retiro en tienda</span>
                                                <span class="delivery-option-desc">Retira tu pedido en nuestra tienda</span>
                                            </div>
                                            <div class="delivery-option-price free">Gratis</div>
                                        </div>
                                    </label>
                                    <label class="delivery-option" data-option="shipping">
                                        <input type="radio" name="delivery_method" value="shipping">
                                        <div class="delivery-option-content">
                                            <div class="delivery-option-icon">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="1" y="3" width="15" height="13"></rect>
                                                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                                </svg>
                                            </div>
                                            <div class="delivery-option-info">
                                                <span class="delivery-option-title">Env√≠o a domicilio</span>
                                                <span class="delivery-option-desc">Recibe en la comodidad de tu hogar</span>
                                            </div>
                                            <div class="delivery-option-price" id="shippingPriceLabel">$5.000</div>
                                        </div>
                                    </label>
                                </div>
                                <p class="free-shipping-notice" id="freeShippingNotice">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="16" x2="12" y2="12"></line>
                                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                    </svg>
                                    <span>Env√≠o gratis en compras sobre $50.000</span>
                                </p>
                            </div>
                        </div>

                        <!-- Card 3: Shipping Address (conditional) -->
                        <div class="checkout-card checkout-card-shipping" id="shippingCard" style="display: none;">
                            <div class="checkout-card-header">
                                <span class="checkout-card-number">3</span>
                                <h3 class="checkout-card-title">Direcci√≥n de Env√≠o</h3>
                            </div>
                            <div class="checkout-card-body">
                                <div class="checkout-field">
                                    <label for="customerAddress">Direcci√≥n completa</label>
                                    <input type="text" id="customerAddress" name="address" autocomplete="street-address" placeholder="Av. Principal 123, Depto 45">
                                    <span class="field-error" id="customerAddressError"></span>
                                </div>
                                <div class="checkout-field-row">
                                    <div class="checkout-field">
                                        <label for="customerCity">Comuna / Ciudad</label>
                                        <input type="text" id="customerCity" name="city" autocomplete="address-level2" placeholder="Santiago Centro">
                                        <span class="field-error" id="customerCityError"></span>
                                    </div>
                                    <div class="checkout-field">
                                        <label for="deliveryDate">Fecha de entrega <span class="optional-tag">(opcional)</span></label>
                                        <input type="date" id="deliveryDate" name="delivery_date">
                                    </div>
                                </div>
                                <div class="checkout-field">
                                    <label for="deliveryNotes">Indicaciones para el repartidor <span class="optional-tag">(opcional)</span></label>
                                    <textarea id="deliveryNotes" name="delivery_notes" rows="2" placeholder="Ej: Tocar timbre, dejar con el conserje, casa color azul..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Card 4: Discount Code -->
                        <div class="checkout-card checkout-card-discount">
                            <div class="checkout-card-header collapsed" id="discountHeader">
                                <div class="discount-header-content">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M8.5 14.5l7-7"></path>
                                        <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"></circle>
                                        <circle cx="15.5" cy="15.5" r="1.5" fill="currentColor"></circle>
                                    </svg>
                                    <span>¬øTienes un c√≥digo de descuento?</span>
                                </div>
                                <svg class="chevron-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                            <div class="checkout-card-body discount-body" id="discountBody" style="display: none;">
                                <div class="discount-input-wrapper">
                                    <input type="text" id="discountCode" placeholder="Ingresa tu c√≥digo" autocomplete="off">
                                    <button class="btn-apply-discount" id="applyDiscountBtn" type="button">
                                        <span class="btn-text">Aplicar</span>
                                        <span class="btn-loading" style="display: none;">
                                            <svg class="spinner-small" width="16" height="16" viewBox="0 0 24 24">
                                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.416" stroke-dashoffset="10"></circle>
                                            </svg>
                                        </span>
                                    </button>
                                </div>
                                <div class="discount-applied" id="discountApplied" style="display: none;">
                                    <div class="discount-applied-info">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        <span id="discountText">DESCUENTO10 aplicado</span>
                                    </div>
                                    <button id="removeDiscountBtn" type="button" class="btn-remove-discount">Quitar</button>
                                </div>
                                <p id="discountStatus" class="discount-status"></p>
                            </div>
                        </div>
                    </form>

                    <!-- Order Summary -->
                    <div class="order-summary-box">
                        <div class="summary-rows">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span id="subtotal">$0</span>
                            </div>
                            <div class="summary-row" id="shippingRow">
                                <span>Env√≠o</span>
                                <span id="shipping">Retiro en tienda</span>
                            </div>
                            <div class="summary-row discount-row" id="discountRow" style="display: none;">
                                <span>Descuento</span>
                                <span id="discountAmount">-$0</span>
                            </div>
                        </div>

                        <div class="summary-total">
                            <span>Total a pagar</span>
                            <span id="total">$0</span>
                        </div>

                        <!-- Checkout Button -->
                        <button class="btn-checkout" id="checkoutBtn" type="button">
                            <span class="btn-checkout-content">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
                                    <line x1="1" y1="10" x2="23" y2="10" />
                                </svg>
                                <span>Pagar con Webpay</span>
                            </span>
                            <span class="btn-checkout-loading" style="display: none;">
                                <svg class="spinner" width="20" height="20" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.416" stroke-dashoffset="10"></circle>
                                </svg>
                                <span>Procesando...</span>
                            </span>
                        </button>

                        <a href="productos.html" class="continue-shopping">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Seguir comprando
                        </a>

                        <!-- Secure Badge -->
                        <div class="secure-badges">
                            <div class="secure-badge">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                                </svg>
                                <span>Pago seguro</span>
                            </div>
                            <div class="secure-badge">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                <span>Datos protegidos</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer" id="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section footer-about">
                    <div class="footer-logo">
                        <span class="footer-logo-text">MT</span>
                        <h3>Mi Tienda</h3>
                    </div>
                    <p class="footer-description">Tu tienda online de confianza con los mejores productos.</p>
                    <div class="footer-social">
                        <a href="https://facebook.com" target="_blank" rel="noopener" aria-label="Facebook">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                            </svg>
                        </a>
                        <a href="https://instagram.com" target="_blank" rel="noopener" aria-label="Instagram">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259 0-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                            </svg>
                        </a>
                        <a href="https://wa.me/56912345678" target="_blank" rel="noopener" aria-label="WhatsApp">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M20.52 3.48A11.86 11.86 0 0 0 12.06 0C5.5 0 .18 5.32.18 11.88c0 2.1.55 4.15 1.6 5.97L0 24l6.32-1.74a11.86 11.86 0 0 0 5.74 1.46h.01c6.56 0 11.88-5.33 11.88-11.89 0-3.18-1.24-6.16-3.43-8.35Z" />
                            </svg>
                        </a>
                    </div>
                </div>

                <div class="footer-section footer-links">
                    <h4 class="footer-title">Enlaces</h4>
                    <ul>
                        <li><a href="/home.html">Inicio</a></li>
                        <li><a href="productos.html">Productos</a></li>
                        <li><a href="nosotros.html">Nosotros</a></li>
                        <li><a href="contacto.html">Contacto</a></li>
                    </ul>
                </div>

                <div class="footer-section footer-contact">
                    <h4 class="footer-title">Contacto</h4>
                    <ul>
                        <li>üìç Av. Providencia 1234, Santiago</li>
                        <li>üìû +56 9 1234 5678</li>
                        <li>‚úâÔ∏è contacto@mitienda.cl</li>
                    </ul>
                </div>

                <div class="footer-section footer-legal">
                    <h4 class="footer-title">Legal</h4>
                    <ul>
                        <li><a href="privacidad.html">Privacidad</a></li>
                        <li><a href="terminos.html">T√©rminos</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Mi Tienda. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Social Float -->
    <div class="social-float-container" id="socialFloat">
        <a class="social-float social-whatsapp" href="https://wa.me/56912345678" target="_blank" rel="noopener" aria-label="WhatsApp">
            <span class="social-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M20.52 3.48A11.86 11.86 0 0 0 12.06 0C5.5 0 .18 5.32.18 11.88c0 2.1.55 4.15 1.6 5.97L0 24l6.32-1.74a11.86 11.86 0 0 0 5.74 1.46h.01c6.56 0 11.88-5.33 11.88-11.89 0-3.18-1.24-6.16-3.43-8.35Z" />
                </svg>
            </span>
            <span class="social-text">WhatsApp</span>
        </a>
        <a class="social-float social-facebook" href="https://facebook.com/mitienda" target="_blank" rel="noopener" aria-label="Facebook">
            <span class="social-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                </svg>
            </span>
            <span class="social-text">Facebook</span>
        </a>
        <a class="social-float social-instagram" href="https://instagram.com/mitienda" target="_blank" rel="noopener" aria-label="Instagram">
            <span class="social-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259 0-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                </svg>
            </span>
            <span class="social-text">Instagram</span>
        </a>
    </div>

    <!-- Scripts -->
    <script src="/js/config.js?v=6.5"></script>
    <script src="/js/utils.js?v=6.5"></script>
    <script src="/js/auth.js?v=6.5" defer></script>
    <script src="/js/cart.js?v=6.5"></script>
    <script src="/js/api.js?v=6.5"></script>
    <script src="/js/header.js?v=6.5" defer></script>
    <script src="/js/wishlist.js?v=6.5"></script>
    <script src="/js/script.js?v=6.5"></script>

    <script>
        // ============================================
        // CHECKOUT STATE & CONSTANTS
        // ============================================
        const CHECKOUT_DATA_KEY = 'checkout_saved_data';
        const SHIPPING_COST = 5000;
        const FREE_SHIPPING_THRESHOLD = 50000;
        
        let appliedDiscount = 0;
        let discountCode = null;
        let discountType = null;
        let discountValue = 0;

        document.addEventListener('DOMContentLoaded', () => {
            renderCartPage();
            initCartActions();
            initCheckoutForm();
            initDeliveryOptions();
            initDiscountSection();
            loadSavedCheckoutData();
        });

        // ============================================
        // CART RENDERING
        // ============================================
        function renderCartPage() {
            const container = document.getElementById('cartItems');
            const badge = document.getElementById('cartBadge');
            const actionsContainer = document.getElementById('cartActions');
            const summaryContainer = document.getElementById('cartSummary');

            if (!container || typeof cart === 'undefined') return;

            const items = cart.getAll();

            if (badge) {
                badge.textContent = `(${items.length} producto${items.length !== 1 ? 's' : ''})`;
            }

            if (actionsContainer) {
                actionsContainer.style.display = items.length > 0 ? 'flex' : 'none';
            }
            if (summaryContainer) {
                summaryContainer.style.display = items.length > 0 ? 'block' : 'none';
            }

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="cart-empty">
                        <div class="empty-icon">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="9" cy="21" r="1"/>
                                <circle cx="20" cy="21" r="1"/>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                            </svg>
                        </div>
                        <h2>Tu carrito est√° vac√≠o</h2>
                        <p>Agrega productos para comenzar tu compra</p>
                        <a href="productos.html" class="btn btn-primary">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <path d="M16 10a4 4 0 0 1-8 0"/>
                            </svg>
                            Explorar Productos
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => createCartItemHTML(item)).join('');
            attachCartItemListeners();
            updateTotals();
        }

        function createCartItemHTML(item) {
            const id = item.product_id || item.id;
            const name = item.name || item.nombre || 'Producto';
            const price = item.price || item.precio || 0;
            const image = item.image_url || item.imagen || '/images/products/placeholder.png';
            const brand = item.brand || item.marca || '';
            const quantity = item.quantity || 1;
            const lineTotal = price * quantity;

            return `
                <div class="cart-item" data-id="${id}">
                    <div class="cart-item-image" onclick="window.location.href='producto.html?id=${id}'">
                        <img src="${image}" alt="${escapeHtml(name)}" loading="lazy">
                    </div>
                    <div class="cart-item-details">
                        ${brand ? `<span class="item-brand">${escapeHtml(brand)}</span>` : ''}
                        <h3 class="item-name" onclick="window.location.href='producto.html?id=${id}'">${escapeHtml(name)}</h3>
                        <span class="item-price-unit">${formatPrice(price)} c/u</span>
                        <div class="quantity-controls">
                            <button class="qty-btn" data-action="decrease" data-id="${id}" ${quantity <= 1 ? 'disabled' : ''}>‚àí</button>
                            <span class="qty-display">${quantity}</span>
                            <button class="qty-btn" data-action="increase" data-id="${id}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-right">
                        <span class="item-line-total">${formatPrice(lineTotal)}</span>
                        <button class="btn-remove-item" data-id="${id}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
        }

        function attachCartItemListeners() {
            document.querySelectorAll('.qty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const action = btn.dataset.action;
                    const items = cart.getAll();
                    const item = items.find(i => String(i.product_id || i.id) === String(id));

                    if (item) {
                        const newQty = action === 'increase' ? item.quantity + 1 : item.quantity - 1;
                        if (newQty <= 0) {
                            removeCartItem(id);
                        } else {
                            cart.updateQuantity(id, newQty);
                            renderCartPage();
                        }
                    }
                });
            });

            document.querySelectorAll('.btn-remove-item').forEach(btn => {
                btn.addEventListener('click', () => removeCartItem(btn.dataset.id));
            });
        }

        function removeCartItem(id) {
            const itemEl = document.querySelector(`.cart-item[data-id="${id}"]`);
            if (itemEl) {
                itemEl.classList.add('removing');
                setTimeout(() => {
                    cart.remove(id);
                    renderCartPage();
                    showNotification('Producto eliminado del carrito');
                }, 300);
            }
        }

        // ============================================
        // DELIVERY OPTIONS (Radio Buttons)
        // ============================================
        function initDeliveryOptions() {
            const deliveryOptions = document.querySelectorAll('input[name="delivery_method"]');
            const shippingCard = document.getElementById('shippingCard');
            const shippingPriceLabel = document.getElementById('shippingPriceLabel');
            const freeShippingNotice = document.getElementById('freeShippingNotice');
            
            deliveryOptions.forEach(option => {
                option.addEventListener('change', () => {
                    const isShipping = option.value === 'shipping';
                    
                    // Toggle shipping card visibility with animation
                    if (shippingCard) {
                        if (isShipping) {
                            shippingCard.style.display = 'block';
                            shippingCard.classList.add('slide-in');
                        } else {
                            shippingCard.classList.remove('slide-in');
                            shippingCard.style.display = 'none';
                        }
                    }
                    
                    // Update visual selection
                    document.querySelectorAll('.delivery-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.closest('.delivery-option')?.classList.add('selected');
                    
                    updateTotals();
                });
            });
            
            // Set initial selection
            const checkedOption = document.querySelector('input[name="delivery_method"]:checked');
            if (checkedOption) {
                checkedOption.closest('.delivery-option')?.classList.add('selected');
            }
            
            // Update shipping price based on subtotal
            updateShippingPriceLabel();
        }
        
        function updateShippingPriceLabel() {
            const subtotal = cart.getSubtotal();
            const shippingPriceLabel = document.getElementById('shippingPriceLabel');
            const freeShippingNotice = document.getElementById('freeShippingNotice');
            
            if (shippingPriceLabel) {
                if (subtotal >= FREE_SHIPPING_THRESHOLD) {
                    shippingPriceLabel.textContent = 'Gratis';
                    shippingPriceLabel.classList.add('free');
                } else {
                    shippingPriceLabel.textContent = formatPrice(SHIPPING_COST);
                    shippingPriceLabel.classList.remove('free');
                }
            }
            
            if (freeShippingNotice) {
                const remaining = FREE_SHIPPING_THRESHOLD - subtotal;
                if (remaining > 0) {
                    freeShippingNotice.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>Te faltan <strong>${formatPrice(remaining)}</strong> para env√≠o gratis</span>
                    `;
                    freeShippingNotice.style.display = 'flex';
                } else {
                    freeShippingNotice.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span><strong>¬°Tienes env√≠o gratis!</strong></span>
                    `;
                    freeShippingNotice.classList.add('success');
                }
            }
        }
        
        function needsShipping() {
            const shippingRadio = document.querySelector('input[name="delivery_method"][value="shipping"]');
            return shippingRadio?.checked || false;
        }

        // ============================================
        // DISCOUNT SECTION (Collapsible)
        // ============================================
        function initDiscountSection() {
            const discountHeader = document.getElementById('discountHeader');
            const discountBody = document.getElementById('discountBody');
            
            if (discountHeader && discountBody) {
                discountHeader.addEventListener('click', () => {
                    const isExpanded = discountBody.style.display !== 'none';
                    discountBody.style.display = isExpanded ? 'none' : 'block';
                    discountHeader.classList.toggle('expanded', !isExpanded);
                });
            }
        }

        // ============================================
        // TOTALS & SUMMARY
        // ============================================
        function updateTotals() {
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');
            const discountAmountEl = document.getElementById('discountAmount');
            const discountRowEl = document.getElementById('discountRow');
            const shippingEl = document.getElementById('shipping');

            const subtotal = cart.getSubtotal();
            const isShipping = needsShipping();
            const freeShipping = subtotal >= FREE_SHIPPING_THRESHOLD;
            const shippingCost = (isShipping && !freeShipping) ? SHIPPING_COST : 0;
            const discount = appliedDiscount;
            const total = Math.max(0, subtotal - discount + shippingCost);

            if (subtotalEl) subtotalEl.textContent = formatPrice(subtotal);
            if (totalEl) totalEl.textContent = formatPrice(total);

            if (shippingEl) {
                if (isShipping) {
                    if (freeShipping) {
                        shippingEl.textContent = 'Gratis';
                        shippingEl.className = 'shipping-free';
                    } else {
                        shippingEl.textContent = formatPrice(shippingCost);
                        shippingEl.className = '';
                    }
                } else {
                    shippingEl.textContent = 'Retiro en tienda';
                    shippingEl.className = '';
                }
            }

            if (discountRowEl && discountAmountEl) {
                if (discount > 0) {
                    discountRowEl.style.display = 'flex';
                    discountAmountEl.textContent = `-${formatPrice(discount)}`;
                } else {
                    discountRowEl.style.display = 'none';
                }
            }
            
            // Update shipping price label in delivery options
            updateShippingPriceLabel();
        }

        // ============================================
        // CHECKOUT FORM INITIALIZATION
        // ============================================
        function initCheckoutForm() {
            const deliveryDateInput = document.getElementById('deliveryDate');

            // Set minimum date for delivery (tomorrow)
            if (deliveryDateInput) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                deliveryDateInput.min = tomorrow.toISOString().split('T')[0];
            }

            // Real-time validation on blur
            const requiredFields = ['customerName', 'customerPhone'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', () => validateField(field));
                    field.addEventListener('input', () => clearFieldError(field));
                }
            });
        }
        
        function validateField(field) {
            const value = field.value.trim();
            const errorEl = document.getElementById(field.id + 'Error');
            
            if (field.required && !value) {
                field.classList.add('error');
                if (errorEl) errorEl.textContent = 'Este campo es requerido';
                return false;
            }
            
            field.classList.remove('error');
            if (errorEl) errorEl.textContent = '';
            return true;
        }
        
        function clearFieldError(field) {
            field.classList.remove('error');
            const errorEl = document.getElementById(field.id + 'Error');
            if (errorEl) errorEl.textContent = '';
        }

        // ============================================
        // DATA PERSISTENCE (Save/Load)
        // ============================================
        function loadSavedCheckoutData() {
            try {
                // First priority: logged-in user data
                const userData = localStorage.getItem('user');
                if (userData) {
                    const user = JSON.parse(userData);
                    prefillField('customerName', user.name);
                    prefillField('customerEmail', user.email);
                    prefillField('customerPhone', user.phone);
                    prefillField('customerAddress', user.address);
                    prefillField('customerCity', user.city);
                    return;
                }
                
                // Second priority: saved checkout data
                const savedData = localStorage.getItem(CHECKOUT_DATA_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    prefillField('customerName', data.name);
                    prefillField('customerPhone', data.phone);
                    prefillField('customerEmail', data.email);
                    prefillField('customerAddress', data.address);
                    prefillField('customerCity', data.city);
                    
                    // Check the save checkbox
                    const saveCheckbox = document.getElementById('saveUserData');
                    if (saveCheckbox) saveCheckbox.checked = true;
                }
            } catch (e) {
                console.debug('Error loading saved data:', e);
            }
        }
        
        function prefillField(id, value) {
            const field = document.getElementById(id);
            if (field && value && !field.value) {
                field.value = value;
            }
        }
        
        function saveCheckoutData() {
            const saveCheckbox = document.getElementById('saveUserData');
            if (!saveCheckbox?.checked) {
                localStorage.removeItem(CHECKOUT_DATA_KEY);
                return;
            }
            
            const data = {
                name: document.getElementById('customerName')?.value.trim() || '',
                phone: document.getElementById('customerPhone')?.value.trim() || '',
                email: document.getElementById('customerEmail')?.value.trim() || '',
                address: document.getElementById('customerAddress')?.value.trim() || '',
                city: document.getElementById('customerCity')?.value.trim() || '',
                savedAt: Date.now()
            };
            
            localStorage.setItem(CHECKOUT_DATA_KEY, JSON.stringify(data));
        }

        // ============================================
        // FORM VALIDATION
        // ============================================
        function validateCheckoutForm() {
            let isValid = true;
            
            // Validate name
            const nameField = document.getElementById('customerName');
            if (!nameField?.value.trim()) {
                showFieldError('customerName', 'Ingresa tu nombre completo');
                isValid = false;
            }
            
            // Validate phone
            const phoneField = document.getElementById('customerPhone');
            if (!phoneField?.value.trim()) {
                showFieldError('customerPhone', 'Ingresa tu n√∫mero de tel√©fono');
                isValid = false;
            }
            
            // Validate shipping fields if needed
            if (needsShipping()) {
                const addressField = document.getElementById('customerAddress');
                const cityField = document.getElementById('customerCity');
                
                if (!addressField?.value.trim()) {
                    showFieldError('customerAddress', 'Ingresa tu direcci√≥n');
                    isValid = false;
                }
                
                if (!cityField?.value.trim()) {
                    showFieldError('customerCity', 'Ingresa tu comuna o ciudad');
                    isValid = false;
                }
            }
            
            if (!isValid) {
                showNotification('Por favor completa los campos requeridos', 'error');
                // Scroll to first error
                const firstError = document.querySelector('.checkout-field input.error');
                firstError?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError?.focus();
            }
            
            return isValid;
        }
        
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorEl = document.getElementById(fieldId + 'Error');
            
            if (field) field.classList.add('error');
            if (errorEl) errorEl.textContent = message;
        }

        function getCheckoutFormData() {
            const isShipping = needsShipping();
            const subtotal = cart.getSubtotal();
            const freeShipping = subtotal >= FREE_SHIPPING_THRESHOLD;
            const shippingCost = (isShipping && !freeShipping) ? SHIPPING_COST : 0;

            return {
                customer_name: document.getElementById('customerName')?.value.trim() || '',
                customer_phone: document.getElementById('customerPhone')?.value.trim() || '',
                customer_email: document.getElementById('customerEmail')?.value.trim() || null,
                needs_shipping: isShipping,
                customer_address: isShipping ? document.getElementById('customerAddress')?.value.trim() : null,
                customer_city: isShipping ? document.getElementById('customerCity')?.value.trim() : null,
                delivery_date: isShipping ? document.getElementById('deliveryDate')?.value || null : null,
                delivery_notes: isShipping ? document.getElementById('deliveryNotes')?.value.trim() || null : null,
                shipping_cost: shippingCost
            };
        }

        // ============================================
        // CART ACTIONS
        // ============================================
        function initCartActions() {
            // Clear cart button
            document.getElementById('clearCartBtn')?.addEventListener('click', () => {
                if (cart.getCount() === 0) return;
                if (confirm('¬øEst√°s seguro de vaciar tu carrito?')) {
                    cart.clear();
                    renderCartPage();
                    showNotification('Carrito vaciado');
                }
            });

            // Apply discount
            document.getElementById('applyDiscountBtn')?.addEventListener('click', applyDiscountCode);
            document.getElementById('discountCode')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyDiscountCode();
                }
            });

            // Remove discount
            document.getElementById('removeDiscountBtn')?.addEventListener('click', removeDiscount);

            // Checkout button
            document.getElementById('checkoutBtn')?.addEventListener('click', handleCheckout);

            // Listen for cart updates
            document.addEventListener('cartUpdated', renderCartPage);
        }

        async function applyDiscountCode() {
            const codeInput = document.getElementById('discountCode');
            const applyBtn = document.getElementById('applyDiscountBtn');
            const code = codeInput?.value.trim().toUpperCase();

            if (!code) {
                setDiscountStatus('Ingresa un c√≥digo de descuento', 'error');
                return;
            }

            // Show loading
            if (applyBtn) {
                applyBtn.querySelector('.btn-text').style.display = 'none';
                applyBtn.querySelector('.btn-loading').style.display = 'inline-flex';
                applyBtn.disabled = true;
            }

            try {
                setDiscountStatus('Validando...', 'info');
                
                // Try API first
                if (typeof api !== 'undefined' && api.validateDiscountCode) {
                    try {
                        const result = await api.validateDiscountCode(code);
                        if (result.valid) {
                            applyValidDiscount(result.code, result.discount_type, result.discount_value);
                            return;
                        }
                    } catch (apiError) {
                        // Fall through to mock codes
                    }
                }

                // Mock discount codes (fallback)
                const discounts = {
                    'DESCUENTO10': { type: 'percentage', value: 10 },
                    'DESCUENTO20': { type: 'percentage', value: 20 },
                    'BIENVENIDO': { type: 'percentage', value: 15 }
                };

                if (discounts[code]) {
                    applyValidDiscount(code, discounts[code].type, discounts[code].value);
                } else {
                    setDiscountStatus('C√≥digo de descuento inv√°lido', 'error');
                }
            } finally {
                // Hide loading
                if (applyBtn) {
                    applyBtn.querySelector('.btn-text').style.display = 'inline';
                    applyBtn.querySelector('.btn-loading').style.display = 'none';
                    applyBtn.disabled = false;
                }
            }
        }
        
        function applyValidDiscount(code, type, value) {
            discountCode = code;
            discountType = type;
            discountValue = value;
            
            const subtotal = cart.getSubtotal();
            appliedDiscount = type === 'percentage' 
                ? Math.round(subtotal * (value / 100)) 
                : value;

            document.getElementById('discountApplied').style.display = 'flex';
            document.getElementById('discountText').textContent = `${code} (-${value}${type === 'percentage' ? '%' : ''})`;
            document.getElementById('discountCode').disabled = true;
            setDiscountStatus('', 'success');
            updateTotals();
            showNotification(`¬°C√≥digo ${code} aplicado!`, 'success');
        }
        
        function removeDiscount() {
            appliedDiscount = 0;
            discountCode = null;
            discountType = null;
            discountValue = 0;
            
            document.getElementById('discountApplied').style.display = 'none';
            document.getElementById('discountCode').value = '';
            document.getElementById('discountCode').disabled = false;
            setDiscountStatus('');
            updateTotals();
            showNotification('Descuento eliminado');
        }

        function setDiscountStatus(text, type = 'info') {
            const statusEl = document.getElementById('discountStatus');
            if (statusEl) {
                statusEl.textContent = text;
                statusEl.className = 'discount-status ' + type;
            }
        }

        // ============================================
        // CHECKOUT HANDLER
        // ============================================
        async function handleCheckout() {
            if (cart.getCount() === 0) {
                showNotification('Tu carrito est√° vac√≠o', 'error');
                return;
            }

            if (!validateCheckoutForm()) {
                return;
            }

            // Save data if checkbox is checked
            saveCheckoutData();

            // Check login
            const token = localStorage.getItem('auth_token');
            if (!token) {
                showNotification('Debes iniciar sesi√≥n para continuar', 'warning');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            const checkoutBtn = document.getElementById('checkoutBtn');
            const contentEl = checkoutBtn.querySelector('.btn-checkout-content');
            const loadingEl = checkoutBtn.querySelector('.btn-checkout-loading');

            try {
                // Show loading state
                checkoutBtn.disabled = true;
                if (contentEl) contentEl.style.display = 'none';
                if (loadingEl) loadingEl.style.display = 'inline-flex';

                const formData = getCheckoutFormData();
                const subtotal = cart.getSubtotal();
                const total = Math.max(0, subtotal - appliedDiscount + formData.shipping_cost);

                // Create transaction
                const result = await api.createTransaction({
                    items: cart.getItemsForApi(),
                    amount: total,
                    ...formData,
                    discount_code: discountCode,
                    discount_amount: appliedDiscount
                });

                // Create Webpay payment
                const orderId = result.order_id || result.transaction?.order_id;
                const paymentResult = await api.webpayCreate(orderId);

                if (paymentResult.url && paymentResult.token) {
                    // Redirect to Webpay
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = paymentResult.url;

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'token_ws';
                    input.value = paymentResult.token;

                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                } else {
                    throw new Error('No se pudo iniciar el proceso de pago');
                }
            } catch (error) {
                showNotification(error.message || 'Error al procesar el pago', 'error');
                checkoutBtn.disabled = false;
                if (contentEl) contentEl.style.display = 'inline-flex';
                if (loadingEl) loadingEl.style.display = 'none';
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.cart-notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `cart-notification cart-notification-${type}`;
            
            const icons = {
                success: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
                error: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
                warning: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
                info: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
            };
            
            notification.innerHTML = `
                ${icons[type] || icons.info}
                <span>${escapeHtml(message)}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Trigger animation
            requestAnimationFrame(() => notification.classList.add('show'));
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatPrice(price) {
            return '$' + new Intl.NumberFormat('es-CL', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }
    </script>
</body>

</html>